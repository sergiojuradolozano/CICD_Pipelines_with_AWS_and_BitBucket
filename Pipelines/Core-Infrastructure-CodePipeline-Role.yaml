AWSTemplateFormatVersion: '2010-09-09'
Description: 'Role and Policy for -Core-Infrastructure'
Parameters:
  Environment:
    Type: String
    Default: dev-
    AllowedValues:
      - dev-
      - uat-
      - prod-
    Description: Enter dev-, uat- or prod-. Default is dev-
  Region:
    Type: String
    Default: us-east-1
    AllowedValues:
      - us-east-1
      - eu-west-1
      - eu-central-1
      - eu-central-2

Mappings:
  DeploymentEnvironmentMap:
    dev-:
      env: dev
    uat-:
      env: uat
    prod-:
      env: prod

Resources:
  CoreInfrastructureRole:
    Type: "AWS::IAM::Role"
    Properties:
      Tags:
        - Key: Environment
          Value: !Join [ "", [ { "Fn::FindInMap": [ "DeploymentEnvironmentMap", !Ref Environment, "env" ] } ] ]
        - Key: Package
          Value: core-network
        - Key: Application
          Value: INFRA
        - Key: CostCentre
          Value: 
      RoleName: "-Core-Infrastructure-Role-CodePipeline"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
                - codebuild.amazonaws.com
                - cloudformation.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: "/"
  RolePolicies:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "-Core-Infrastructure-Role-CodePipeline"
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - codestar-connections:UseConnection
            Resource: '*'
          - Effect: Allow
            Action:
              - codebuild:CreateReportGroup
              - codebuild:CreateReport
              - codebuild:StartBuild
              - codebuild:UpdateReport
              - codebuild:BatchPutCodeCoverages
              - codebuild:BatchPutTestCases
              - codebuild:BatchGetBuilds
              - codebuild:BatchGetProjects

            Resource:
              - !Sub arn:aws:codebuild:${Region}:${AWS::AccountId}:report-group/-Core-Network-CodeBuild-*
              - !Sub arn:aws:codebuild:${Region}:${AWS::AccountId}:project/-Core-Infrastructure
              - !Sub arn:aws:codebuild:${Region}:${AWS::AccountId}:report-group/-Core-Network-CodeBuild-*

          - Sid: VisualEditor0
            Effect: Allow
            Action:
              - s3:ListBucket
              - cloudformation:CreateChangeSet
              - cloudformation:DeleteChangeSet
              - logs:CreateLogStream
              - iam:PassRole
              - iam:TagRole
              - lambda:DeleteLayerVersion
              - lambda:UpdateFunctionConfiguration
              - cloudformation:UpdateStack
              - cloudformation:DescribeChangeSet
              - cloudformation:ExecuteChangeSet
              - s3:GetBucketAcl
              - logs:CreateLogGroup
              - logs:PutLogEvents
              - cloudformation:DescribeStacks
              - s3:PutObject
              - s3:GetObject
              - cloudformation:GetStackPolicy
              - cloudformation:CreateStack
              - cloudformation:DeleteStack
              - s3:GetBucketLocation
              - s3:GetObjectVersion
              - lambda:AddLayerVersionPermission
              - lambda:AddPermission
              - lambda:CreateAlias
              - lambda:CreateFunction
              - lambda:DeleteAlias
              - lambda:DeleteFunction
              - lambda:GetAccountSettings
              - lambda:GetAlias
              - lambda:GetEventSourceMapping
              - lambda:GetFunction
              - lambda:GetFunctionConfiguration
              - lambda:GetLayerVersion
              - lambda:GetLayerVersionPolicy
              - lambda:GetPolicy
              - lambda:InvokeFunction
              - lambda:ListAliases
              - lambda:ListEventSourceMappings
              - lambda:ListFunctions
              - lambda:ListLayerVersions
              - lambda:ListLayers
              - lambda:ListTags
              - lambda:ListVersionsByFunction
              - lambda:PublishLayerVersion
              - lambda:PublishVersion
              - lambda:RemoveLayerVersionPermission
              - lambda:RemovePermission
              - lambda:TagResource
              - lambda:UntagResource
            Resource:
              - !Sub arn:aws:logs:${Region}:${AWS::AccountId}:log-group:-Core-Infrastructure-CodeBuild:*
              - !Sub arn:aws:iam::${AWS::AccountId}:role/-Core-Infrastructure-Role-CodePipeline
              - !Sub arn:aws:iam::${AWS::AccountId}:role/${Environment}-${Region}-genericRegionalLambdaRole
              - !Join [ "", [ "arn:aws:s3:::", { "Fn::FindInMap": [ "DeploymentEnvironmentMap", !Ref Environment, "env" ] }, ".", { "Fn::Sub": "${Region}" }, ".-deployment*" ] ]
              - !Join [ "", [ "arn:aws:s3:::", { "Fn::FindInMap": [ "DeploymentEnvironmentMap", !Ref Environment, "env" ] }, ".", { "Fn::Sub": "${Region}" }, ".ultumus-deployment*" ] ]
              - !Sub arn:aws:s3:::codepipeline-${Region}-*
              - !Sub arn:aws:cloudformation:${Region}:${AWS::AccountId}:stack/${Environment}-infrastructure-aws/*
              - !Sub arn:aws:lambda:${Region}:${AWS::AccountId}:layer:${Environment}*
          - Sid: VisualEditor1
            Effect: Allow
            Action:
              - ec2:RevokeSecurityGroupIngress
              - ec2:createTags
              - ec2:CreateNetworkInterface
              - ec2:AuthorizeSecurityGroupEgress
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:DetachNetworkInterface
              - ec2:DescribeSubnets
              - ec2:DescribeVpcs
              - ec2:DescribeNetworkInterfaces
              - ec2:CreateSecurityGroup
              - ec2:RevokeSecurityGroupEgress
              - ec2:DeleteSecurityGroup
              - ec2:DeleteNetworkInterface
              - ec2:AttachNetworkInterface
              - ec2:DescribeSecurityGroups
            Resource: '*'
          - Sid: VisualEditor2
            Effect: Allow
            Action:
              - lambda:CreateFunction
              - iam:GetRole
              - iam:TagRole
              - iam:GetPolicy
              - lambda:GetFunction
              - iam:DeleteRole
              - iam:DeleteRolePolicy
              - iam:DeletePolicy
              - iam:CreateRole
              - lambda:DeleteFunction
              - iam:GetRolePolicy
            Resource:
              - !Sub arn:aws:iam::${AWS::AccountId}:role/${Environment}-infrastructure-*
              - !Sub arn:aws:iam::${AWS::AccountId}:role/${Environment}-${Region}*
              - !Sub arn:aws:lambda:${Region}:${AWS::AccountId}:function:${Environment}-*
              - !Sub arn:aws:iam::${AWS::AccountId}:policy/*
          - Effect: Allow
            Action:
              - iam:PutRolePolicy
              - lambda:DeleteEventSourceMapping
            Resource:
              - !Sub arn:aws:lambda:${Region}:${AWS::AccountId}:event-source-mapping:*
              - !Sub arn:aws:iam::${AWS::AccountId}:role/${Environment}-infrastructure*
          - Sid: VisualEditor3
            Effect: Allow
            Action:
              - lambda:CreateEventSourceMapping
              - lambda:GetEventSourceMapping
            Resource: '*'
          - Effect: Allow
            Action:
              - SNS:GetTopicAttributes
              - SNS:CreateTopic
              - SNS:Subscribe
              - SNS:TagResource
              - SNS:DeleteTopic
              - sqs:CreateQueue
              - sqs:DeleteQueue
              - sqs:SendMessage
              - sqs:ReceiveMessage
              - sqs:GetQueueUrl
              - sqs:ListDeadLetterSourceQueues
              - sqs:ListQueues
              - sqs:ListQueueTags
              - sqs:GetQueueAttributes
              - sqs:SetQueueAttributes
            Resource:
              - !Sub arn:aws:sns:${Region}:${AWS::AccountId}:${Environment}-*
              - !Sub arn:aws:sqs:${Region}:${AWS::AccountId}:${Environment}-*
          - Effect: Allow
            Action:
              - cloudformation:ValidateTemplate
              - cloudformation:GetStackPolicy
              - cloudformation:CreateStack
              - cloudformation:DeleteStack
              - cloudformation:UpdateStack
              - cloudformation:CreateChangeSet
              - cloudformation:DescribeChangeSet
              - cloudformation:ExecuteChangeSet
              - cloudformation:DeleteChangeSet
              - cloudformation:ValidateTemplate
              - cloudformation:DescribeStacks
            Resource:
              - !Sub arn:aws:cloudformation:${Region}:${AWS::AccountId}:stack/${Environment}-infrastructure-aws/*
      Roles:
        - Ref: "CoreInfrastructureRole"

Outputs:
  CoreInfrastructureRole:
    Value: !Ref CoreInfrastructureRole
    Export:
      Name: CoreInfrastructureRole

  CoreInfrastructureRoleArn:
    Value: !GetAtt CoreInfrastructureRole.Arn
    Export:
      Name: CoreInfrastructureRoleArn